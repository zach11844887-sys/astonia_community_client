FROM cachyos/cachyos:latest

# Linux development environment with clang-tidy and analysis tools
# Use this for development, debugging, and code analysis

# Upgrade system with auto-resolve enabled
# Use --needed to skip already-installed packages and avoid 404 errors on old versions
RUN pacman -Syyu --noconfirm --needed --ask=4 --overwrite="*"

# Install basic dependencies and development tools
RUN pacman -S --noconfirm --needed --ask=4 --overwrite="*" \
    curl \
    wget \
    git \
    base-devel \
    libpng \
    libzip \
    zlib \
    zig \
    unzip \
    && pacman -Scc --noconfirm

# Install Clang tooling for analysis
RUN pacman -S --noconfirm --needed --ask=4 --overwrite="*" \
    clang \
    clang-tools-extra \
    llvm \
    bear \
    gdb \
    valgrind \
    ccache \
    python-pip \
    vim \
    nano \
    tree \
    htop \
    && pacman -Scc --noconfirm

# Install additional code quality tools
RUN pip install --break-system-packages --no-cache-dir gcovr && \
    pacman -S --noconfirm --needed --ask=4 --overwrite="*" lcov && \
    pacman -Scc --noconfirm

# Install paru AUR helper
# Create a non-root user for building paru (AUR helpers shouldn't run as root)
RUN useradd -m -G wheel -s /bin/bash builder && \
    sed -i 's/^# %wheel ALL=(ALL:ALL) NOPASSWD: ALL/%wheel ALL=(ALL:ALL) NOPASSWD: ALL/' /etc/sudoers

USER builder
WORKDIR /home/builder
RUN git clone https://aur.archlinux.org/paru.git && \
    cd paru && \
    makepkg -si --noconfirm && \
    cd .. && \
    rm -rf paru

# Sync AUR databases with paru
RUN paru -Syu --noconfirm

# Install AUR packages (sdl3-git, sdl3_mixer-git, mimalloc-git)
# Note: SDL3_mixer must be installed separately AFTER sdl3-git to avoid conflicts
USER root
WORKDIR /
RUN sudo -u builder paru -S --noconfirm --needed mimalloc-git sdl3-git && \
    sudo -u builder paru -S --noconfirm --needed sdl3_mixer-git

# Install Rust
RUN curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y --default-toolchain stable
ENV PATH="/root/.cargo/bin:${PATH}"
RUN rustup default stable
RUN rustup component add clippy rustfmt

# Set Zig cache directory
ENV ZIG_GLOBAL_CACHE_DIR="/root/.cache/zig"
ENV ZIG_LOCAL_CACHE_DIR="/tmp/zig-local-cache"

# Configure ccache
ENV PATH="/usr/lib/ccache/bin:${PATH}"
ENV CCACHE_DIR="/root/.ccache"
ENV CCACHE_MAXSIZE="2G"

# Create interactive dev script
RUN printf '#!/bin/bash\n\
echo "=== Astonia Linux Development Environment ==="\n\
echo ""\n\
echo "Available tools:"\n\
echo "  - clang, gcc (compilers with ccache)"\n\
echo "  - clang-tidy (static analysis)"\n\
echo "  - clang-format (code formatting)"\n\
echo "  - bear (compilation database generator)"\n\
echo "  - gdb, valgrind (debugging)"\n\
echo "  - AddressSanitizer/UBSan (sanitizers)"\n\
echo "  - gcovr, lcov (code coverage)"\n\
echo "  - zig (build system)"\n\
echo ""\n\
echo "Quick commands:"\n\
echo "  make linux                    - Build for Linux"\n\
echo "  make sanitizer                - Build with AddressSanitizer"\n\
echo "  make coverage                 - Build with coverage"\n\
echo ""\n\
echo "Analysis:"\n\
echo "  scripts/run-valgrind.sh       - Memory leak detection"\n\
echo "  scripts/run-sanitizer.sh      - Runtime error detection"\n\
echo "  scripts/run-coverage.sh       - Code coverage report"\n\
echo "  scripts/run-clang-tidy.sh fix - Static analysis & fixes"\n\
echo ""\n\
echo "Profiling:"\n\
echo "  scripts/run-perf.sh           - CPU profiling (fast)"\n\
echo "  scripts/run-callgrind.sh      - CPU profiling (detailed)"\n\
echo "  scripts/run-massif.sh         - Memory profiling"\n\
echo "  scripts/run-cachegrind.sh     - Cache profiling"\n\
echo "  See docs/PROFILING.md for detailed guide"\n\
echo ""\n\
exec /bin/bash "$@"\n' > /usr/local/bin/dev-shell.sh && \
    chmod +x /usr/local/bin/dev-shell.sh

WORKDIR /app
ENTRYPOINT ["/bin/bash", "/usr/local/bin/dev-shell.sh"]

name: Code Quality

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  # Format checking for C and Rust code
  format-check:
    name: Format Check
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install clang-format-21
      run: |
        # Add LLVM repository for clang-format-21
        wget -O - https://apt.llvm.org/llvm-snapshot.gpg.key | sudo apt-key add -
        sudo add-apt-repository "deb http://apt.llvm.org/jammy/ llvm-toolchain-jammy-21 main"
        sudo apt-get update
        sudo apt-get install -y clang-format-21
        # Verify installation
        clang-format-21 --version

    - name: Setup Rust
      uses: actions-rust-lang/setup-rust-toolchain@v1
      with:
        toolchain: nightly
        components: rustfmt
        cache: false

    - name: Run format check script
      run: scripts/check-format.sh

  # Static analysis for C code
  static-analysis:
    name: Static Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        # Add LLVM repository for clang-21 tools
        wget -O - https://apt.llvm.org/llvm-snapshot.gpg.key | sudo apt-key add -
        sudo add-apt-repository "deb http://apt.llvm.org/jammy/ llvm-toolchain-jammy-21 main"
        sudo apt-get update
        sudo apt-get install -y \
          clang-21 \
          clang-tidy-21 \
          clang-format-21 \
          bear \
          cppcheck \
          libsdl2-dev \
          libsdl2-mixer-dev \
          libpng-dev \
          libzip-dev \
          zlib1g-dev
        # Create symlinks for version-agnostic names
        sudo update-alternatives --install /usr/bin/clang clang /usr/bin/clang-21 100
        sudo update-alternatives --install /usr/bin/clang-tidy clang-tidy /usr/bin/clang-tidy-21 100
        sudo update-alternatives --install /usr/bin/clang-format clang-format /usr/bin/clang-format-21 100

    - name: Setup Rust
      uses: actions-rust-lang/setup-rust-toolchain@v1
      with:
        toolchain: stable
        cache: true
        cache-workspaces: astonia_net

    - name: Run static analysis script
      run: scripts/check-static-analysis.sh

    - name: Upload analysis reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: static-analysis-reports
        path: build/logs/*.log
        retention-days: 90

  # Rust quality checks
  rust-checks:
    name: Rust Quality Checks
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Rust
      uses: actions-rust-lang/setup-rust-toolchain@v1
      with:
        toolchain: stable
        components: clippy, rustfmt
        cache: true
        cache-workspaces: astonia_net

    - name: Run Rust check script
      run: scripts/check-rust.sh

  # File consistency checks
  file-checks:
    name: File Consistency
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Run file consistency script
      run: scripts/check-files.sh

  # Sanitizer build test
  sanitizer:
    name: AddressSanitizer/UBSan Build
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        # Add LLVM repository for clang-21
        wget -O - https://apt.llvm.org/llvm-snapshot.gpg.key | sudo apt-key add -
        sudo add-apt-repository "deb http://apt.llvm.org/jammy/ llvm-toolchain-jammy-21 main"
        sudo apt-get update
        sudo apt-get install -y \
          clang-21 \
          libsdl2-dev \
          libsdl2-mixer-dev \
          libpng-dev \
          libzip-dev \
          zlib1g-dev
        # Create symlink for clang
        sudo update-alternatives --install /usr/bin/clang clang /usr/bin/clang-21 100

    - name: Setup Rust
      uses: actions-rust-lang/setup-rust-toolchain@v1
      with:
        toolchain: stable
        cache: true
        cache-workspaces: astonia_net

    - name: Build with sanitizers
      run: make sanitizer
      env:
        CC: clang

    - name: Check sanitizer binary
      run: |
        echo "Sanitizer build successful!"
        ls -lh bin/moac-sanitizer
        file bin/moac-sanitizer
